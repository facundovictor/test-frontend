# @author facundovictor
##############################################

# Color of the map points
cultural_blue = '#3665ff'
living_work_red = '#f92322'

# Radius of the map points
circle_radius = 5

# Points in the map.
locations = [
    {
        description: 'Visited Facundo',
        radius: circle_radius,
        country: 'Argentina',
        city: 'Bahía Blanca',
        fillKey: 'cultural',
        date: '2015-12-12',
        latitude: -38.608822,
        longitude: -62.248535
    },{
        description: 'I danced tango and ate asado',
        radius: circle_radius,
        country: 'Argentina',
        city: 'Buenos Aires',
        fillKey: 'cultural',
        date: '2015-12-15',
        latitude: -34.640129,
        longitude: -58.364868
    },{
        description: 'Visited the south of Brazil',
        radius: circle_radius,
        country: 'Brazil',
        city: 'Porto Alegre',
        fillKey: 'cultural',
        date: '2014-03-24',
        latitude: -30.083652,
        longitude: -51.141357
    },{
        description: 'Visited the "Jardim Botânico"',
        radius: circle_radius,
        country: 'Brazil',
        city: 'Curitiba',
        fillKey: 'cultural',
        date: '2014-03-24',
        latitude: -25.442112,
        longitude: -49.287415
    },{
        description: 'Visited the big ben',
        radius: circle_radius,
        country: 'England',
        city: 'London',
        fillKey: 'cultural',
        date: '2011-09-02',
        latitude: 51.302287,
        longitude: 0.131836
    },{
        description: 'Visited Wat Phra Kaew',
        radius: circle_radius,
        country: 'Thailand',
        city: 'Bangkok',
        fillKey: 'cultural',
        date: '2014-07-19',
        latitude: 13.805409,
        longitude: 100.437012
    },{
        description: 'Assisted to Carnaval',
        radius: circle_radius,
        country: 'Spain',
        city: 'Las Palmas de Gran Canaria',
        fillKey: 'cultural',
        date: '2008-10-15',
        latitude: 28.116729,
        longitude: -15.422058
    },{
        description: 'Visited the Cathedral',
        radius: circle_radius,
        country: 'Portugal',
        city: 'Lisbon',
        fillKey: 'cultural',
        date: '2008-11-24',
        latitude: 38.756091,
        longitude: -9.124146
    },{
        description: 'Visited the Alcazaba of Badajoz',
        radius: circle_radius,
        country: 'Spain',
        city: 'Badajoz',
        fillKey: 'cultural',
        date: '2008-11-29',
        latitude: 38.895041,
        longitude: -6.9104
    },{
        description: 'Visited the "Basilica of Our Lady of the PIllar"',
        radius: circle_radius,
        country: 'Spain',
        city: 'Zaragoza',
        fillKey: 'cultural',
        date: '2009-05-03',
        latitude: 41.643927,
        longitude: -0.802002
    },{
        description: 'Visited the Cathedral',
        radius: circle_radius,
        country: 'Spain',
        city: 'Murcia',
        fillKey: 'cultural',
        date: '2014-02-21',
        latitude: 37.965583,
        longitude: -1.219482
    },{
        description: 'Gone to the beach',
        radius: circle_radius,
        country: 'Spain',
        city: 'Palma',
        fillKey: 'cultural',
        date: '2014-09-10',
        latitude: 39.508014,
        longitude: 2.69165
    },{
        description: 'Visited the monument of the Martyrs',
        radius: circle_radius,
        country: 'Algeria',
        city: 'Algiers',
        fillKey: 'cultural',
        date: '2015-01-15',
        latitude: 36.778217,
        longitude: 3.043213
    },{
        description: 'Visited the "Sungai Petani Clock Tower"',
        radius: circle_radius,
        country: 'Malaysia',
        city: 'Sungai Petani',
        fillKey: 'cultural',
        date: '2014-07-10',
        latitude: 5.659548,
        longitude: 100.497437
    },{
        description: 'Visited the Nelum Pokuna Mahinda Rajapaksa Theatre',
        radius: circle_radius,
        country: 'Sri Lanka',
        city: 'Colombo',
        fillKey: 'cultural',
        date: '2014-08-02',
        latitude: 6.873938,
        longitude: 79.93927
    },{
        description: 'Visited the Burj Khalifa',
        radius: circle_radius,
        country: 'United Arab Emirates',
        city: 'Dubai',
        fillKey: 'cultural',
        date: '2015-02-12',
        latitude: 25.189719,
        longitude: 55.184326
    },{
        description: 'Visited the Trevi Fountain',
        radius: circle_radius,
        country: 'Italy',
        city: 'Rome',
        fillKey: 'cultural',
        date: '2011-07-03',
        latitude: 41.8987,
        longitude: 12.501068
    },{
        description: 'Visited the Acropolis of Athens',
        radius: circle_radius,
        country: 'Greece',
        city: 'Athens',
        fillKey: 'cultural',
        date: '2011-07-03',
        latitude: 37.949071,
        longitude: 23.731842
    },{
        description: 'My first amazing job',
        radius: circle_radius,
        country: 'Spain',
        city: 'Mahón',
        fillKey: 'cultural',
        date: '2009-04-15',
        latitude: 39.883265,
        longitude: 4.306641
    },{
        description: 'Visited the Port',
        radius: circle_radius,
        country: 'Tunisia',
        city: 'Bizerte',
        fillKey: 'cultural',
        date: '2009-09-15',
        latitude: 37.291399,
        longitude: 9.879456
    },{
        description: 'Visited my family',
        radius: circle_radius,
        country: 'Italy',
        city: 'Sassati',
        fillKey: 'cultural',
        date: '2009-12-25',
        latitude: 40.731389,
        longitude: 8.521271
    },{
        description: 'Visited the Oude Kerk',
        radius: circle_radius,
        country: 'Netherlands',
        city: 'Amsterdam',
        fillKey: 'cultural',
        date: '2009-12-25',
        latitude: 52.325058,
        longitude: 4.713135
    },{
        description: 'My second amazing work',
        radius: circle_radius,
        country: 'Brazil',
        city: 'São Paulo',
        fillKey: 'living',
        date: '2013-05-10',
        latitude: -23.557772,
        longitude: -46.628723
    },{
        description: 'My third amazing work',
        radius: circle_radius,
        country: 'Brazil',
        city: 'Campinas',
        fillKey: 'living',
        date: '2014-03-24',
        latitude: -22.906618,
        longitude: -47.046204
    },{
        description: 'My current awesome work',
        radius: circle_radius,
        country: 'Spain',
        city: 'Valencia',
        fillKey: 'living',
        date: '2015-05-03',
        latitude: 39.508014,
        longitude: -0.362549
    },{
        description: 'My first amazing job',
        radius: circle_radius,
        country: 'Italy',
        city: 'Cagliari',
        fillKey: 'living',
        date: '2009-03-10',
        latitude: 39.200201,
        longitude: 9.135132
    }
]


# Recovers a square of the map that covers all the map points.
limits = () ->
    max_longitude = -180
    min_longitude = 180
    max_latitude = -90
    min_latitude = 90

    for loc in locations
        min_longitude = loc.longitude if loc.longitude < min_longitude
        max_longitude = loc.longitude if loc.longitude > max_longitude
        min_latitude = loc.latitude if loc.latitude < min_latitude
        max_latitude = loc.latitude if loc.latitude > max_latitude

    {
        max_long: max_longitude,
        min_long: min_longitude,
        max_lat: max_latitude
        min_lat: min_latitude
    }

# LoadMap:
#   Loads the map with the Map points as bubbles.
loadMap = ->
    # Gets the HTML element where the map will be placed.
    mapElement = d3.select '.map'

    # Loads the map and stores it for redraw purposes
    map = new Datamap({
        element: mapElement[0][0],
        scope: 'world',
        responsive: true,
        geographyConfig: {
            popupOnHover: false,
            highlightOnHover: false,
            borderWidth: 0
        },
        bubblesConfig:{
            borderWidth: 0,
            fillOpacity: 1,
            highlightFillColor: '#FFFFFF',
            highlightBorderWidth: 2,
            highlightBorderColor: '#000000'
        },
        fills:{
            'cultural': cultural_blue,
            'living': living_work_red,
            defaultFill: '#e9eaea'
        },
        data: {
            'cultural': {fillKey: 'cultural'},
            'living': {fillKey: 'living'}
        }
    })

    # Loads the location points as map bubbles.
    map.bubbles(locations, {
        popupTemplate: (geo, data) ->
            "<div class=\"hoverinfo\"> #{data.description} \
             <br/> #{data.city}, #{data.country} \
             <br/>On #{data.date} </div>"
        }
    )

    # Get the menu button
    menu_btn = d3.select '.content .menu-btn'

    # Attaches the function to the 'click' event
    menu_btn.on 'click.map', (evt) ->
        window.setTimeout(
            () ->
                map.resize()
        ,300)


# reloadMap:
#   Erases the map and recreates it
reloadMap = () ->
    # Gets the HTML element where the map will be placed.
    mapElement = d3.select '.map'

    # Erases the map
    mapElement[0][0].innerHTML = ''

    # Create it again
    loadMap()

